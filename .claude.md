# Claude Code Instructions for Learn Like Magic

> **Project:** Learn Like Magic - Adaptive Tutoring System
> **Stack:** FastAPI + LangGraph (Backend) | React + Vite (Frontend) | AWS Infrastructure
> **Last Updated:** October 23, 2025

## Project Overview

Learn Like Magic is an AI-powered adaptive tutoring system that uses LangGraph to provide personalized learning experiences. The system analyzes student responses, adapts teaching strategies, and provides targeted feedback.

## Documentation Structure

All project documentation is located in the `docs/` folder:

```
docs/
‚îú‚îÄ‚îÄ deployment.md      # Infrastructure setup, deployment process, troubleshooting
‚îî‚îÄ‚îÄ dev-workflow.md    # Daily development workflows, best practices, testing
```

### Documentation Update Policy

**üî¥ CRITICAL: Always update relevant documentation when making changes**

When you make changes, update the corresponding documentation:

| Change Type | Update Document | Section |
|-------------|----------------|---------|
| Infrastructure (Terraform, AWS) | `docs/deployment.md` | Infrastructure Components, Deployment Process |
| API endpoints, database schema | `docs/deployment.md` + `docs/dev-workflow.md` | Making Changes |
| GitHub Actions workflows | `docs/dev-workflow.md` | Deployment section |
| Local development setup | `docs/dev-workflow.md` | Development Environment Setup |
| Troubleshooting solutions | Both documents | Troubleshooting sections |
| Build process (Makefile, Docker) | `docs/dev-workflow.md` | Making Changes ‚Üí Backend |
| Environment variables | `docs/deployment.md` | Infrastructure Components |

### Before You Commit

- [ ] Code changes made
- [ ] Tests pass (if applicable)
- [ ] Relevant documentation updated
- [ ] Commit message describes WHAT and WHY

## Architecture Overview

### Backend (`llm-backend/`)
- **Framework:** FastAPI + Uvicorn
- **AI/LLM:** LangGraph + OpenAI
- **Database:** PostgreSQL (SQLAlchemy ORM)
- **Deployment:** AWS App Runner (Docker containers)
- **Architecture:** AMD64/x86_64 ‚ö†Ô∏è **CRITICAL - See below**

### Frontend (`llm-frontend/`)
- **Framework:** React + TypeScript
- **Build Tool:** Vite
- **Deployment:** S3 + CloudFront

### Infrastructure (`infra/terraform/`)
- **IaC:** Terraform
- **Cloud:** AWS (us-east-1)
- **Components:** App Runner, RDS Aurora, ECR, S3, CloudFront, Secrets Manager

## Critical Constraints

### üö® Docker Architecture Requirement

**ALWAYS build backend Docker images for AMD64 architecture:**

```bash
# ‚úÖ CORRECT (Production)
docker buildx build --platform linux/amd64 -t image:tag .

# ‚ùå WRONG (Builds for native arch - ARM64 on Mac M-series)
docker build -t image:tag .
```

**Why:** AWS App Runner runs on AMD64. ARM64 images fail silently with no logs.

**How to ensure:**
- Use `make build-prod` in `llm-backend/` (not `docker build`)
- GitHub Actions workflow uses `--platform linux/amd64` flag
- Always verify: `docker inspect IMAGE --format='{{.Architecture}}'` ‚Üí Must be `amd64`

### üîê Security

**Never commit:**
- `.env` files
- API keys (use AWS Secrets Manager)
- Database passwords
- Private keys (`.pem`, `.key`)

**Configuration validation:**
- Required configs validated at runtime (not import time)
- See `llm-backend/config.py` and `llm-backend/main.py` startup event

## File Structure

```
learnlikemagic/
‚îú‚îÄ‚îÄ .claude.md                    # ‚Üê You are here (AI assistant instructions)
‚îú‚îÄ‚îÄ docs/                         # ‚Üê Documentation (KEEP UPDATED!)
‚îÇ   ‚îú‚îÄ‚îÄ deployment.md            # Infrastructure & deployment
‚îÇ   ‚îî‚îÄ‚îÄ dev-workflow.md          # Development workflows
‚îú‚îÄ‚îÄ llm-backend/                 # FastAPI backend
‚îÇ   ‚îú‚îÄ‚îÄ main.py                  # API entry point
‚îÇ   ‚îú‚îÄ‚îÄ models.py                # Pydantic models
‚îÇ   ‚îú‚îÄ‚îÄ config.py                # Settings (runtime validation)
‚îÇ   ‚îú‚îÄ‚îÄ database.py              # DB manager
‚îÇ   ‚îú‚îÄ‚îÄ graph/                   # LangGraph implementation
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile               # Container definition
‚îÇ   ‚îú‚îÄ‚îÄ Makefile                 # Build automation ‚≠ê
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt         # Python dependencies
‚îú‚îÄ‚îÄ llm-frontend/                # React frontend
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ vite.config.ts
‚îú‚îÄ‚îÄ infra/terraform/             # Infrastructure as Code
‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ Makefile                 # Terraform automation ‚≠ê
‚îÇ   ‚îî‚îÄ‚îÄ terraform.tfvars         # Config (gitignored)
‚îú‚îÄ‚îÄ scripts/                     # Helper scripts
‚îÇ   ‚îî‚îÄ‚îÄ set-github-secrets.sh   # GitHub secrets setup
‚îî‚îÄ‚îÄ .github/workflows/           # CI/CD pipelines
    ‚îú‚îÄ‚îÄ deploy-backend.yml       # Backend deployment
    ‚îî‚îÄ‚îÄ deploy-frontend.yml      # Frontend deployment
```

## Common Tasks

### 1. Adding a New API Endpoint

```bash
# 1. Define model in llm-backend/models.py
# 2. Add endpoint in llm-backend/main.py
# 3. Test locally: uvicorn main:app --reload
# 4. Update docs/dev-workflow.md ‚Üí "Adding a New API Endpoint" example
# 5. Commit & push (triggers auto-deployment)
```

### 2. Modifying Database Schema

```bash
# 1. Update model in llm-backend/db.py
# 2. Create migration function
# 3. Test migration locally
# 4. Run migration in production (manual step - see docs/deployment.md)
# 5. Update docs/deployment.md ‚Üí "Database Management" section
# 6. Commit & push
```

### 3. Updating Infrastructure

```bash
# 1. Modify Terraform files in infra/terraform/
# 2. Run: make plan (review changes)
# 3. Run: make apply (deploy changes)
# 4. Update docs/deployment.md ‚Üí "Infrastructure Components" section
# 5. Update GitHub secrets if outputs changed: ./scripts/set-github-secrets.sh
# 6. Commit & push
```

### 4. Fixing Deployment Issues

**First steps:**
1. Check GitHub Actions logs: https://github.com/manishjain-py/learnlikemagic/actions
2. Check App Runner logs: `aws logs tail /aws/apprunner/.../service`
3. Consult `docs/deployment.md` ‚Üí "Troubleshooting" section
4. Verify architecture: `docker inspect IMAGE --format='{{.Architecture}}'`

**If you find a new issue/solution:**
- Document it in `docs/deployment.md` and/or `docs/dev-workflow.md`
- Add to appropriate "Troubleshooting" section
- Include symptoms, causes, and solutions

## Development Workflow

### Local Development

```bash
# Backend
cd llm-backend
make run  # Starts with auto-reload

# Frontend
cd llm-frontend
npm run dev  # Starts with hot reload
```

### Deployment

**Automatic (preferred):**
- Push to `main` branch
- GitHub Actions handles deployment
- Backend triggers on: `llm-backend/**` changes
- Frontend triggers on: `llm-frontend/**` changes

**Manual (if needed):**
```bash
# Backend
cd llm-backend
make deploy  # Build AMD64 ‚Üí Push ECR ‚Üí Trigger App Runner

# Or via GitHub UI:
# https://github.com/manishjain-py/learnlikemagic/actions
# ‚Üí Select workflow ‚Üí "Run workflow"
```

## Environment Configuration

### Required GitHub Secrets

Set at: https://github.com/manishjain-py/learnlikemagic/settings/secrets/actions

```
AWS_REGION                  = us-east-1
AWS_ROLE_ARN               = arn:aws:iam::926211191776:role/...
ECR_REGISTRY               = 926211191776.dkr.ecr.us-east-1.amazonaws.com
ECR_REPOSITORY             = learnlikemagic-backend-production
APP_RUNNER_SERVICE_ARN     = arn:aws:apprunner:us-east-1:926211191776:service/...
FRONTEND_BUCKET            = learnlikemagic-frontend-production
CLOUDFRONT_DISTRIBUTION_ID = E19EYV4ZGTL1L9
VITE_API_URL              = https://ypwbjbcmbd.us-east-1.awsapprunner.com
```

**To update:** Run `./scripts/set-github-secrets.sh` after Terraform changes

### Production URLs

- **Backend API:** https://ypwbjbcmbd.us-east-1.awsapprunner.com
- **Frontend:** https://dlayb9nj2goz.cloudfront.net
- **API Docs:** https://ypwbjbcmbd.us-east-1.awsapprunner.com/docs

## Testing Checklist

Before merging to `main`:

- [ ] Code passes local tests
- [ ] Backend: `curl http://localhost:8000/` returns `{"status":"ok"}`
- [ ] Backend: `curl http://localhost:8000/health/db` connects to database
- [ ] Frontend: Loads without console errors
- [ ] No hardcoded secrets in code
- [ ] Documentation updated (if applicable)
- [ ] Architecture is AMD64 (if Docker changes)

## Troubleshooting Quick Reference

| Issue | First Check | Documentation |
|-------|-------------|---------------|
| Deployment fails | GitHub Actions logs ‚Üí Architecture | `docs/deployment.md` ‚Üí Troubleshooting #1 |
| Health check fails | CloudWatch logs ‚Üí Environment vars | `docs/deployment.md` ‚Üí Troubleshooting #1 |
| No logs in CloudWatch | Container not starting ‚Üí Architecture! | `docs/deployment.md` ‚Üí Troubleshooting #2 |
| GitHub workflow doesn't trigger | Path filter in `.github/workflows/` | `docs/dev-workflow.md` ‚Üí Troubleshooting #4 |
| Local backend won't start | .env file ‚Üí Dependencies ‚Üí Python version | `docs/dev-workflow.md` ‚Üí Troubleshooting #1 |
| Frontend API errors | VITE_API_URL ‚Üí CORS ‚Üí Backend running | `docs/dev-workflow.md` ‚Üí Troubleshooting #2 |

## Making Changes with Claude

### When Modifying Code

1. **Understand the change:** Read relevant docs first
2. **Make changes:** Follow patterns in existing code
3. **Test locally:** Run dev servers, verify functionality
4. **Update docs:** Add to appropriate doc file
5. **Commit properly:** Descriptive message with context

### When Troubleshooting

1. **Check docs first:** Look in `docs/deployment.md` or `docs/dev-workflow.md`
2. **Check logs:** GitHub Actions, CloudWatch, browser console
3. **Verify basics:** Architecture (AMD64), env vars, services running
4. **Document solution:** Add to troubleshooting section if new issue
5. **Update docs:** Keep solutions current

### When Adding Features

1. **Plan the change:** Which files need updates?
2. **Check dependencies:** New packages? Update requirements.txt/package.json
3. **Update models:** Pydantic models for validation
4. **Add tests:** Unit tests for backend, component tests for frontend
5. **Update docs:** Add examples to dev-workflow.md
6. **Deployment considerations:** New env vars? Database changes? Update deployment.md

## Code Quality Standards

### üéØ Core Principles

This project prioritizes **readability, modularity, and maintainability**. All code should follow these principles:

1. **Single Responsibility Principle (SRP)**
   - Each function/class should have one clear purpose
   - If a function does multiple things, split it into smaller functions
   - Example: Separate API handling, business logic, and database operations

2. **DRY (Don't Repeat Yourself)**
   - Extract duplicate code into utility functions
   - Use constants instead of magic numbers
   - Create helper functions for repeated patterns

3. **Separation of Concerns**
   - API layer: Handle HTTP requests/responses only
   - Service layer: Business logic and orchestration
   - Repository layer: Database access only
   - Domain/Model layer: Data structures and validation

4. **Function Size Guidelines**
   - Target: ‚â§30 lines per function
   - If longer: Consider breaking into smaller functions
   - Each function should do ONE thing well

5. **Naming Conventions**
   - Use descriptive names that reveal intent
   - Functions: verb_noun (e.g., `create_session`, `format_history`)
   - Classes: PascalCase nouns (e.g., `SessionService`, `GuidelineRepository`)
   - Constants: UPPER_CASE (e.g., `MAX_STEPS`, `MASTERY_THRESHOLD`)

6. **Dependency Injection**
   - Pass dependencies as parameters, don't create them inside functions
   - Makes testing easier (can mock dependencies)
   - Example: Pass `db` session to services, don't create it inside

7. **Pure Functions Where Possible**
   - Prefer functions with no side effects
   - Input ‚Üí Process ‚Üí Output (no hidden state changes)
   - Makes testing and reasoning about code easier

### üìÅ Code Organization

**Backend Structure:**
```
llm-backend/
‚îú‚îÄ‚îÄ api/              # FastAPI routes (HTTP layer)
‚îú‚îÄ‚îÄ services/         # Business logic
‚îú‚îÄ‚îÄ repositories/     # Database access
‚îú‚îÄ‚îÄ models/           # Data models (Pydantic, SQLAlchemy)
‚îú‚îÄ‚îÄ graph/            # LangGraph nodes (pure logic)
‚îú‚îÄ‚îÄ utils/            # Shared utilities
‚îú‚îÄ‚îÄ prompts/          # External prompt templates
‚îî‚îÄ‚îÄ tests/            # Comprehensive test suite
```

**Key Rules:**
- API routes should be thin - delegate to services
- Services orchestrate business logic - no direct database access
- Repositories handle database operations - return domain models
- Graph nodes should be pure functions - no I/O or database calls
- Prompts should be in external files, not hardcoded in code

### üß™ Testing Requirements

- Write tests for all new features
- Aim for >70% test coverage
- Unit tests for services, repositories, utilities
- Integration tests for API endpoints
- Use fixtures for test data

### üìù Documentation Standards

**Code Comments:**
- Docstrings for all public functions/classes
- Explain WHY, not WHAT (code should be self-documenting)
- Update comments when changing code

**External Documentation:**
- Update `docs/dev-workflow.md` for new development patterns
- Update `docs/deployment.md` for infrastructure changes
- Keep `README.md` current with setup instructions

### üîÑ Refactoring Guidelines

When you see code that violates these principles:
1. Flag it for improvement
2. Suggest refactoring if time permits
3. Don't make it worse - improve or maintain quality
4. See `llm-backend/refactor-plan.txt` for ongoing refactoring efforts

**Common Refactoring Triggers:**
- Function > 30 lines ‚Üí Break it down
- Duplicate code ‚Üí Extract utility function
- Magic numbers ‚Üí Move to constants
- Mixed concerns ‚Üí Separate into layers
- Hardcoded strings ‚Üí Extract to config/constants

## Best Practices for Claude

### DO:
‚úÖ Always read `docs/deployment.md` and `docs/dev-workflow.md` before major changes
‚úÖ Update documentation when making changes
‚úÖ Build Docker images with `make build-prod` (ensures AMD64)
‚úÖ Verify architecture before pushing: `docker inspect IMAGE --format='{{.Architecture}}'`
‚úÖ Use descriptive commit messages explaining WHY
‚úÖ Follow existing code patterns and structure
‚úÖ Add to troubleshooting sections when solving new issues
‚úÖ **Write modular, readable code following SRP and DRY principles**
‚úÖ **Extract duplicate code and magic numbers into utilities/constants**
‚úÖ **Keep functions small (‚â§30 lines) with clear, single purposes**
‚úÖ **Separate concerns: API ‚Üí Services ‚Üí Repositories ‚Üí Database**
‚úÖ **Add tests for new features and maintain >70% coverage**

### DON'T:
‚ùå Use `docker build` directly for production (use `make build-prod`)
‚ùå Commit without updating relevant documentation
‚ùå Hardcode secrets or API keys
‚ùå Skip the architecture check for Docker images
‚ùå Make breaking changes without updating deployment docs
‚ùå Ignore path filters in GitHub Actions workflows
‚ùå Forget to validate changes locally before committing
‚ùå **Write functions longer than 30 lines without breaking them down**
‚ùå **Mix API logic, business logic, and database operations in one function**
‚ùå **Duplicate code - extract to utilities instead**
‚ùå **Hardcode prompts, messages, or magic numbers - use constants/config files**
‚ùå **Skip tests for new features**

## Quick Links

- **GitHub Repository:** https://github.com/manishjain-py/learnlikemagic
- **GitHub Actions:** https://github.com/manishjain-py/learnlikemagic/actions
- **AWS Console:** https://us-east-1.console.aws.amazon.com/
- **Terraform State:** `infra/terraform/terraform.tfstate`

## Contact & Support

For issues:
1. Check documentation in `docs/`
2. Check GitHub Actions logs
3. Check AWS CloudWatch logs
4. Review this file for common patterns

---

**Remember:** This project has comprehensive documentation in `docs/`. Always consult and update it when making changes. The docs are your source of truth!

**Code Quality:** This project prioritizes readable, modular, maintainable code. Always follow SRP, DRY, and separation of concerns. See the "Code Quality Standards" section above and `llm-backend/refactor-plan.txt` for detailed guidelines.

**Last Updated:** October 23, 2025
**Version:** 1.1
